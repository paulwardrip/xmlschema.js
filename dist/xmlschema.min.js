function XsSimpleTypeValidator(a,b){this.xml=a;var c=this.xml.getElementsByTagName("restriction")[0];c&&(this.base=this.xml.getElementsByTagName("restriction")[0].getAttribute("base")),this.length=this.xml.getElementsByTagName("length")[0]?this.xml.getElementsByTagName("length")[0].getAttribute("value"):0,this.minLength=this.xml.getElementsByTagName("minLength")[0]?this.xml.getElementsByTagName("minLength")[0].getAttribute("value"):0,this.maxLength=this.xml.getElementsByTagName("maxLength")[0]?this.xml.getElementsByTagName("maxLength")[0].getAttribute("value"):0,this.pattern=this.xml.getElementsByTagName("pattern")[0]?this.xml.getElementsByTagName("pattern")[0].getAttribute("value"):null,this.isNumber=function(){var a=!1,b=this.base,c=["byte","decimal","double","int","float","integer","long","negativeInteger","nonNegativeInteger","nonPositiveInteger","positiveInteger","short","unsignedLong","unsignedInt","unsignedShort","unsignedByte"];return c.some(function(c){if("xs:"+c===b)return a=!0,!0}),a},this.isNumber()&&(this.fractionDigits=this.xml.getElementsByTagName("fractionDigits")[0]?this.xml.getElementsByTagName("fractionDigits")[0].getAttribute("value"):null,this.maxInclusive=this.xml.getElementsByTagName("maxInclusive")[0]?this.xml.getElementsByTagName("maxInclusive")[0].getAttribute("value"):null,this.maxExclusive=this.xml.getElementsByTagName("maxExclusive")[0]?this.xml.getElementsByTagName("maxExclusive")[0].getAttribute("value"):null,this.minInclusive=this.xml.getElementsByTagName("minInclusive")[0]?this.xml.getElementsByTagName("minInclusive")[0].getAttribute("value"):null,this.minExclusive=this.xml.getElementsByTagName("minExclusive")[0]?this.xml.getElementsByTagName("minExclusive")[0].getAttribute("value"):null,this.totalDigits=this.xml.getElementsByTagName("totalDigits")[0]?this.xml.getElementsByTagName("totalDigits")[0].getAttribute("value"):null);var d=[];Array.prototype.slice.call(this.xml.getElementsByTagName("enumeration")).forEach(function(a){d.push(a.getAttribute("value"))}),this.enumeration=d,this.validate=function(a){function c(a){d.valid=!1,d.error=a}var d={valid:!0};if(this.enumeration.length>0){var e=!1;this.enumeration.forEach(function(b){if(a===b)return e=!0,!0}),e||c("Value of "+b+" does not match enumerated options.")}else this.isNumber()?/^[0-9.\-]*$/.test(a)?this.minInclusive&&parseFloat(a)<this.minInclusive?c("Value of "+b+" should be greater than "+this.minInclusive+" (inclusive)."):this.minExclusive&&parseFloat(a)<=this.minExclusive?c("Value of "+b+" should be greater than "+this.minExclusive+" (exclusive)."):this.maxInclusive&&parseFloat(a)>this.maxInclusive?c("Value of "+b+" should be less than "+this.maxInclusive+" (inclusive)."):this.maxExclusive&&parseFloat(a)>=this.maxExclusive?c("Value of "+b+" should be greater than "+this.maxExclusive+" (exclusive)."):this.totalDigits&&this.totalDigits!==a.replace(/\./,"").length?c("Value of "+b+" should be "+this.totalDigits+" digits."):this.fractionDigits&&this.fractionDigits<a.split(/\./)[1].length&&c("Value of "+b+" should have only "+this.fractionDigits+" digits past the decimal."):c("Value of "+b+" should be numeric."):"xs:string"===this.base&&(this.length>0&&a.length!==this.length?c("Value of "+b+" should be exactly "+this.length+"characters."):this.minLength>0&&a.length<this.minLength?c("Value of "+b+" should be at least "+this.minLength+"characters."):this.maxLength>0&&a.length>this.maxLength?c("Value of "+b+" exceeds "+this.maxLength+"characters."):this.pattern&&!new RegExp(this.pattern).test(a)&&c("Value of "+b+" does not match the specified pattern."));return d}}var xmlparser={parse:function(a){function b(a,b){if("undefined"!=typeof jQuery){try{c.doc=$.parseXML(a),c.str=a,c.parser="jQuery",b&&(c.uri=b)}catch(e){d.reject("XML could not be parsed.")}c.doc?d.resolve(c):d.reject("XML could not be parsed.")}else if("undefined"!=typeof DOMParser){var f=new DOMParser;c.doc=f.parseFromString(a,"application/xml"),c.str=a,c.parser="DOMParser",b&&(c.uri=b),c.doc.getElementsByTagName("parsererror").length>0?d.reject("XML could not be parsed."):d.resolve(c)}}var c={doc:null,str:null},d=xmlparser.deferred();if("object"==typeof a){if(a instanceof XMLDocument)c.doc=a,"undefined"!=typeof XMLSerializer&&(c.str=(new XMLSerializer).serializeToString(a)),d.resolve(c);else if("undefined"!=typeof jQuery&&a instanceof jQuery){var e=$(a.children()[0]).html(),f=a.children()[0].tagName,g="<"+f;$.each(a.children()[0].attributes,function(){g+=" "+this.name+'="'+this.value+'"'}),g+=">\n"+e+"\n<"+f+">",b(g),d.resolve(c)}}else if("string"==typeof a)if(/\.(xml|xsd)$/.test(a))if("undefined"!=typeof jQuery){var h=$.get(a,{},function(c){b(c,a)},"text");h["catch"](function(){d.reject("Could not read file: "+a)})}else{var i;if("undefined"!=typeof XMLHttpRequest)i=new XMLHttpRequest;else if("undefined"!=typeof ActiveXObject)try{i=new ActiveXObject("Msxml2.XMLHTTP")}catch(j){try{i=new ActiveXObject("Microsoft.XMLHTTP")}catch(k){i=null}}"undefined"!==i?(i.open("GET",a),i.setRequestHeader("Content-Type","application/xml"),i.onreadystatechange=function(){4===this.readyState&&(200===this.status?b(this.responseText,a):(c.error="Unable to request document, response code: "+this.status,d.reject(c)))},i.send(null)):(c.error="Unable to request document, browser does not support XMLHttpRequest and jQuery is not available.",d.reject(c))}else b(a);return d.promise()},deferred:function(){return"undefined"!=typeof jQuery?$.Deferred():"undefined"!=typeof Promise?function(){var a=null,b=null,c=new Promise(function(c,d){a=c,b=d});return{promise:function(){return c},resolve:a,reject:b}}():new function(){var a,b=!1,c=!1,d=[],e=[];this.resolve=function(c){b=!0,a=c,d.forEach(function(b){b(a)})},this.reject=function(b){c=!0,a=b,e.forEach(function(b){b(a)})},this.promise={then:function(c){return b?c(a):d.push(c),this},"catch":function(b){return c?b(a):e.push(b),this}}}}},xmlschema=function(a){function b(a,b){return Array.prototype.slice.call(a.getElementsByTagName(b),0)}function c(a){a?(this.url=a,this["default"]=!1):(this.url=null,this["default"]=!0),this.simpleTypes={},this.complexTypes={},this.attributeGroups={},this.groups={},this.unique=[]}function d(a,b,c){var d=[];a.childNodes.forEach(function(a){a.nodeType===Node.ELEMENT_NODE&&"xs:element"===a.tagName?d.push(n(c,a,b)):a.nodeType===Node.ELEMENT_NODE&&"xs:any"===a.tagName&&d.push(new f(a))}),this.id=a.getAttribute("id"),this.minOccurs=a.getAttribute("minOccurs")||1,this.maxOccurs=a.getAttribute("maxOccurs")||1,this.choices=d,this.number=w++,this.from="xs:choice",this.ns=c.url}function e(a,b,c,d){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.type=a.getAttribute("type"),this.minOccurs=a.getAttribute("minOccurs")||1,this.maxOccurs=function(){return a.getAttribute("maxOccurs")?a.getAttribute("maxOccurs"):c?"unbounded":1}(),b?this.xml=d.simpleTypes[b].elem:this.xml=a.getElementsByTagName("simpleType")[0],this.validator=new XsSimpleTypeValidator(this.xml,"<"+a.getAttribute("name")+">"),this.from="xs:simpleType",this.ns=d.url}function f(a){this.minOccurs=a.getAttribute("minOccurs")||1,this.maxOccurs=a.getAttribute("maxOccurs")||1,this.from="xs:any",this.number=v++}function g(a){this.minOccurs=a.getAttribute("minOccurs")||1,this.maxOccurs=a.getAttribute("maxOccurs")||1,this.from="xs:anyAttribute",this.number=v++}function h(a,b,c){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.type=a.getAttribute("type"),this.minOccurs=a.getAttribute("minOccurs")||1,this.maxOccurs=function(){return a.getAttribute("maxOccurs")?a.getAttribute("maxOccurs"):b?"unbounded":1}(),this.from=a.getAttribute("type"),this.ns=c.url}function i(a,b,c,d,e){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.type=b,this.minOccurs=a.getAttribute("minOccurs")||1,this.maxOccurs=function(){return a.getAttribute("maxOccurs")?a.getAttribute("maxOccurs"):c?"unbounded":1}(),this.children=[],this.attributes=[],this.from="xs:complexType",b?this.xml=d.complexTypes[b].elem:this.xml=a.getElementsByTagName("complexType")[0],this.ns=e}function j(a,b){this.type=a.getAttribute("type"),this.name=a.getAttribute("name"),this.required=a.getAttribute("use")&&"required"===a.getAttribute("use"),this.prohibited=a.getAttribute("use")&&"prohibited"===a.getAttribute("use"),a.getAttribute("type")?this.xml=b.simpleTypes[a.getAttribute("type")].elem:a.getElementsByTagName("simpleType")&&(this.xml=a.getElementsByTagName("simpleType")[0]),this.xml&&(this.validator=new XsSimpleTypeValidator(this.xml,"@"+a.getAttribute("name"))),this.ns=b.url}function k(a){var b;return y.some(function(c){if(a&&c.url===a||!a&&c["default"])return b=c,!0}),b||(b=new c(a),y.push(b)),b}function l(a){var b={prefixes:{}};return Array.prototype.slice.call(a.attributes).forEach(function(a){if("xmlns"===a.name)b.xmlns=a.value;else if(a.name.indexOf("xmlns:")>-1){var c=a.name.replace(/xmlns:/,"");b[c]=a.value}}),b}function m(a,c,d){b(a,"anyAttribute").forEach(function(a){c.attributes.push(new g(a))}),b(a,"attribute").forEach(function(a){c.attributes.push(new j(a,d))})}function n(a,c,d){function f(a){var c=a.getElementsByTagName("sequence")[0],d=a.getElementsByTagName("all")[0],e=b(a,"group");e.forEach(function(a){f(l.groups[a.getAttribute("ref")].elem)}),b(a,"attributeGroup").forEach(function(a){m(l.attributeGroups[a.getAttribute("ref")].elem,g,l)});var h=a.getElementsByTagName("complexContent")[0];if(h){var i=h.getElementsByTagName("extension")[0].getAttribute("base"),j=l.complexTypes[i].elem||e[i].elem;f(j)}c?(g.sequence=!0,o(c,l,g.children,g.sequence)):d&&(g.sequence=!1,o(d,l,g.children,g.sequence)),m(a,g,l)}var g;Array.prototype.slice.call(c.getElementsByTagName("unique")).forEach(function(a){var b={name:a.getAttribute("name"),selector:a.getElementsByTagName("selector")[0].getAttribute("xpath"),field:a.getElementsByTagName("field")[0].getAttribute("xpath")};x.push(b)});var j,l=a;if(c.getAttribute("type"))if(c.getAttribute("type").indexOf(":")>-1&&!/^xsi?:/.test(c.getAttribute("type"))){var n=c.getAttribute("type").split(/:/);l=k(a.prefixes.prefixes[n[0]]),j=n[1]}else j=c.getAttribute("type");return j&&l.simpleTypes[j]||c.getElementsByTagName("simpleType").length>0?g=new e(c,j,d,l):j&&l.complexTypes[j]||c.getElementsByTagName("complexType").length>0?(g=new i(c,j,d,l,a.uri),f(g.xml)):g=new h(c,d,l),g}function o(a,b,c,e){var g;a.childNodes.forEach(function(a){var h;a.nodeType===Node.ELEMENT_NODE&&"xs:element"===a.tagName?h=n(b,a,e):a.nodeType===Node.ELEMENT_NODE&&"xs:choice"===a.tagName?h=new d(a,e,b):a.nodeType===Node.ELEMENT_NODE&&"xs:any"===a.tagName&&(h=new f(a)),h&&(g&&(g.next=h),g=h,c.push(h))})}function p(a,b,c){var d=xmlparser.deferred(),e=[!1],f=k(b);return xmlparser.parse(a).then(function(a){function g(a,b,c){/^http/.test(a)?c(a):b?c(b.substring(0,b.lastIndexOf("/")+1)+a):z?z.then(function(){console.log(A);var b=A.doc.firstChild.getAttribute("schemaLocation").split(/[\r\n\s]+/)[1];c(b.substring(0,b.lastIndexOf("/")+1)+a)}):c()}function h(){var b=!0;for(var g in e)if(!e[g]){b=!1;break}b&&(c&&(f.prefixes=l(a.doc.firstChild),o(a.doc.firstChild,f,u,!1)),d.resolve(a))}a.doc&&(a.doc.firstChild.childNodes.forEach(function(c){if(c.nodeType!==Node.ELEMENT_NODE||"xs:include"!==c.tagName&&"xs:import"!==c.tagName)c.nodeType===Node.ELEMENT_NODE&&"xs:simpleType"===c.tagName?f.simpleTypes[c.getAttribute("name")]={elem:c,ns:b}:c.nodeType===Node.ELEMENT_NODE&&"xs:complexType"===c.tagName?f.complexTypes[c.getAttribute("name")]={elem:c,ns:b}:c.nodeType===Node.ELEMENT_NODE&&"xs:group"===c.tagName?f.groups[c.getAttribute("name")]={elem:c,ns:b}:c.nodeType===Node.ELEMENT_NODE&&"xs:attributeGroup"===c.tagName&&(f.attributeGroups[c.getAttribute("name")]={elem:c,ns:b});else{var i=e.length;e.push(!1),g(c.getAttribute("schemaLocation"),a.uri,function(a){if(a){var b="xs:import"===c.tagName?c.getAttribute("namespace"):null,f=p(a,b,!1);f.then(function(){e[i]=!0,h()})["catch"](function(){d.reject("Could not load include: "+c.getAttribute("schemaLocation"))})}else d.reject("Could not load include: "+c.getAttribute("schemaLocation"))})}}),e[0]=!0,h())})["catch"](function(){d.reject()}),d.promise()}function q(){t.then(function(a){s=a,xmlschemadocument=s.doc})}function r(a,b){function c(a){o.errors.push(a),console.log(a)}function j(){function a(a,b,c){return b+"defaultns:"+c}function b(a){return"defaultns"===a?A.doc.documentElement.getAttribute("xmlns"):void e(a)}var d=new XPathEvaluator,e=d.createNSResolver(A.doc.documentElement);x.forEach(function(e){for(var f=e.selector.replace(/^()([\w\-_:]+)/,a).replace(/(\/{1,2})([\w\-_:]+)/,a),g=d.evaluate(f,A.doc.documentElement,b,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),h={},i=0;i<g.snapshotLength;i++){var j=g.snapshotItem(i),k=e.field.replace(/^()([\w\-_:]+)/,a).replace(/(\/{1,2})([\w\-_:]+)/,a),l=d.evaluate(k,j,b,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(l.snapshotLength>0){var m=l.snapshotItem(0);h[m.nodeValue]?c("Unique constraint "+e.name+" violated on <"+j.tagName+">"):h[m.nodeValue]=!0}else warn("Could not evaluate unique constraint "+e.name+" on <"+j.tagName+"> field not found, xpath: "+e.field)}})}function k(a,b,j){function l(a){var b=a.split(":"),c=1===b.length?{name:b[0]}:{prefix:b[0],name:b[1]};return c.ns=r.prefixes[c.prefix]||r.xmlns,c}function m(a){w[a]?w[a]++:w[a]=1,q=a,t=l(a),console.debug("Element validated",t.name,"[",t.ns,"]")}function p(b){c("Too many instances of <"+b.name+"> exceeding the maximum of "+b.maxOccurs+", parent element "+a[0].parentNode.tagName)}var q,s,t,u=[],v=[],w={};a.forEach(function(a){function k(b){if(n.elements++,m(a.tagName),s=b,b instanceof f)lastany=b.number;else if(b instanceof i){var d={};Array.prototype.slice.call(a.attributes).forEach(function(e){if(e.name.indexOf("xmlns")===-1&&e.name.indexOf("schemaLocation")===-1){var f=!1,h=!1;b.attributes.forEach(function(b){if(b instanceof g)h=!0;else if(e.name===b.name)if(n.attributes++,f=!0,d[e.name]=void 0!==d[e.name]?d[e.name]+1:1,b.prohibited)c("Attribute <"+a.tagName+" @"+e.name+"> is prohibited.");else if(void 0!==b.validator){var i=b.validator.validate(e.value);i.valid||c(i.error)}}),f||h||c("Unexpected attribute <"+a.tagName+" @"+e.name+">")}}),b.attributes.forEach(function(b){!d[b.name]&&b.required?c("Attribute is required <"+a.tagName+" @"+b.name+">"):d[b.name]>1&&c("Duplicate attribute <"+a.tagName+" @"+b.name+">")}),u.push({parent:a.tagName,nodes:a.childNodes,tree:b.children,sequence:b.sequence})}else if(b instanceof e&&a.firstChild){var j=b.validator.validate(a.firstChild.nodeValue);j.valid||c(j.error)}if((b instanceof e||b instanceof h)&&(!a.firstChild||!a.firstChild.nodeValue)){var k="Empty element <"+a.tagName+"> has no value.";o.warnings.push(k),console.warn(k)}return z=!0,!0}function p(a,b,c){if(!a)return!1;var d=a.name===b,e=a.ns===c||!a.prefix&&!c;return d&&e}function r(b){function e(){b.choices.forEach(function(a){if(p(t,a.name,b.ns))return A=!0,!0}),b.choices.forEach(function(a){if((!j||A||!q)&&p(C,a.name,b.ns))return k(a),!0})}if(j?b instanceof d?e():b instanceof f&&lastany==b.number?A=!0:p(t,b.name,b.ns)?(A=!0,B++,B>w[b.name]&&k(b)):!A&&q||(!x&&b instanceof f&&(x=b),p(C,b.name,b.ns)?(k(b),x&&x.minOccurs>0&&c("An element not specified by the schema is required and did not match with an element in the XML document.")):(y.push(b.name),b.minOccurs>0&&v.push({element:a,expected:y}))):p(C,b,b.ns)?k(b):b instanceof d&&e(),z)return!0}if(a.nodeType===Node.ELEMENT_NODE){var x,y=[],z=!1;if(a.tagName===q)k(s);else{var A=!1,B=0,C=l(a.tagName);b.some(r),x&&k(x),z||c("Invalid element <"+a.tagName+"> not allowed, parent: "+a.parentNode.tagName)}}}),v.forEach(function(a){if(!j){var d=[];b.forEach(function(b){w[b.name]?b.maxOccurs>w[b.name]&&d.push(b.name):a.expected.push(b.name)}),0===a.expected.length&&(a.expected=d)}var e="Elements out of sequence, found <"+a.element.tagName+"> expected [",f=!0;a.expected.forEach(function(a){f||(e+=", "),e+=a,f=!1}),c(e+"], parent: "+a.element.parentNode.tagName)}),b.forEach(function(b){if(b instanceof d){var e,f=0;if(b.choices.forEach(function(a){w[a.name]&&(e||(e=a,f++))}),!e&&b.minOccurs>0){var g="Required choice not present, options: [",h=!0;b.choices.forEach(function(a){h||(g+=", "),g+=a.name,h=!1}),c(g+"].")}else if("unbounded"!==b.maxOccurs&&f>b.maxOccurs){var g="Too many choices selected from list: [",h=!0;b.choices.forEach(function(a){h||(g+=", "),g+=a.name,h=!1}),c(g+"] "+f+" options found, maximum is "+b.maxOccurs)}}else!w[b.name]&&b.minOccurs>0?c("Required element <"+b.name+"> missing, parent: "+a[0].parentNode.tagName):"unbounded"!==b.maxOccurs&&w[b.name]>b.maxOccurs&&p(b)}),u.forEach(function(a){k(a.nodes,a.tree,a.sequence)})}var m=xmlparser.deferred(),n={elements:0,attributes:0};b&&m.then(b);var o={errors:[],warnings:[],message:null,valid:!1},r={};return z=xmlparser.parse(a).then(function(a){if(A=a,A.doc&&!t){var b;A.doc.firstChild.getAttribute("xsi:schemaLocation")?b=A.doc.firstChild.getAttribute("xsi:schemaLocation").split(/[\r\n\s]+/)[1]:A.doc.firstChild.getAttribute("xsi:noNamespaceSchemaLocation")&&(b=A.doc.firstChild.getAttribute("xsi:noNamespaceSchemaLocation")),b&&b.indexOf("http")>-1&&(console.log("Loading schema from document: "+b),t=p(b,null,!0),q())}return t?t.then(function(){s.doc?A.doc?(r=l(A.doc.firstChild),k(A.doc.childNodes,u,!0),j(),o.valid=0===o.errors.length,o.xml=A,o.xsd=s,o.message="Validated "+n.elements+" elements and "+n.attributes+" attributes, document is "+(o.valid?"valid":"invalid")+"."):(c("XML could not be parsed."),c(A.error)):(c("XSD could not be parsed."),c(s.error)),m.resolve(o)})["catch"](function(a){console.log(a),m.reject(a)}):m.reject("No schema document loaded."),o})["catch"](function(a){console.log(a),m.reject(a)}),m.promise()}var s,t,u=[],v=0,w=0,x=[],y=[];a&&(t=p(a,null,!0),q());var z,A,B={validate:r,xmlparser:xmlparser};return"undefined"!=typeof xsdoptions&&(B.xsdoptions=xsdoptions),"undefined"!=typeof xmljson&&(B.xmljson=xmljson),B},xmlschemadocument;"undefined"!=typeof module&&(module.exports=xmlschema);